<!DOCTYPE html>  <html> <head>   <title>recording-proxy.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="app.html">                 app.coffee               </a>                                           <a class="source" href="mock-http-server.html">                 mock-http-server.coffee               </a>                                           <a class="source" href="playback-server.html">                 playback-server.coffee               </a>                                           <a class="source" href="recording-proxy.html">                 recording-proxy.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               recording-proxy.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><strong>recording-proxy.coffee</strong>
Proxy request to the target server and store responses in a file
specific to the request.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">events      = </span><span class="nx">require</span> <span class="s">&#39;events&#39;</span>
<span class="nv">http        = </span><span class="nx">require</span> <span class="s">&#39;http&#39;</span>
<span class="nv">fs          = </span><span class="nx">require</span> <span class="s">&#39;fs&#39;</span>
<span class="nv">path        = </span><span class="nx">require</span> <span class="s">&#39;path&#39;</span>
<span class="nv">crypto      = </span><span class="nx">require</span> <span class="s">&#39;crypto&#39;</span>
<span class="nv">querystring = </span><span class="nx">require</span> <span class="s">&#39;querystring&#39;</span>
<span class="nv">mock        = </span><span class="nx">require</span> <span class="s">&#39;../src/mock-http-server&#39;</span>

<span class="nv">exports.RecordingProxy = </span><span class="k">class</span> <span class="nx">RecordingProxy</span> <span class="k">extends</span> <span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span>
  <span class="nv">constructor: </span><span class="nf">(@options = {}) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Set up directory</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">fixtureDir = </span><span class="nx">options</span><span class="p">.</span><span class="nx">fixtures</span> <span class="o">||</span> <span class="s">&#39;fixtures&#39;</span>
    <span class="vi">@fixturePath = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../</span><span class="si">#{</span><span class="nx">fixtureDir</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">mkdirSync</span> <span class="nx">@fixturePath</span> <span class="nx">unless</span> <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">@fixturePath</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Set up target information</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@target = </span><span class="nx">options</span><span class="p">.</span><span class="nx">target</span>
    <span class="nx">unless</span> <span class="nx">@target</span><span class="o">?</span><span class="p">.</span><span class="nx">host</span> <span class="o">and</span> <span class="nx">options</span><span class="p">.</span><span class="nx">target</span><span class="o">?</span><span class="p">.</span><span class="nx">port</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;options must contain target.host and target.port&quot;</span><span class="p">)</span>
    <span class="vi">@target.agent = </span><span class="nx">mock</span><span class="p">.</span><span class="nx">_getAgent</span><span class="p">(</span><span class="nx">@target</span><span class="p">)</span>
    <span class="vi">@target.protocol = </span><span class="nx">mock</span><span class="p">.</span><span class="nx">_getProtocol</span><span class="p">(</span><span class="nx">@target</span><span class="p">)</span>
    <span class="vi">@target.base = </span><span class="nx">mock</span><span class="p">.</span><span class="nx">_getBase</span><span class="p">(</span><span class="nx">@target</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Called once for each request to the HTTP server.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">proxyRequest: </span><span class="nf">(req, res) -&gt;</span>
    <span class="nv">self      = </span><span class="nx">@</span>
    <span class="nv">outgoing  = </span><span class="k">new</span><span class="p">(</span><span class="nx">@target</span><span class="p">.</span><span class="nx">base</span><span class="p">)</span>
    <span class="nv">errState  = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Capture data written to res so that when
the response is finished, we can store
the data into the response file.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">res.recording =</span>
      <span class="nv">method: </span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span>
      <span class="nv">url: </span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span>
      <span class="nv">data: </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Override the writeHead method in order
to save the <code>statusCode</code> and <code>headers</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_writeHead = </span><span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span>
    <span class="nv">res.writeHead = </span><span class="nf">(statusCode, headers) -&gt;</span>
      <span class="nv">res.recording.statusCode = </span><span class="nx">statusCode</span>
      <span class="nv">res.recording.headers = </span><span class="nx">headers</span>
      <span class="nx">_writeHead</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">arguments</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Override the write method in order
to save the response <code>body</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_write = </span><span class="nx">res</span><span class="p">.</span><span class="nx">write</span>
    <span class="nv">res.write = </span><span class="nf">(chunk) -&gt;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">recording</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">push</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s">&#39;base64&#39;</span><span class="p">)</span>
      <span class="nx">_write</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">arguments</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Save recorded data to file.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">writeRecordingToFile = </span><span class="o">-&gt;</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;recording does not have a filename&quot;</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">res</span><span class="p">.</span><span class="nx">recording</span><span class="p">.</span><span class="nx">filename</span>
      <span class="nv">filepath = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">self</span><span class="p">.</span><span class="nx">fixturePath</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">res</span><span class="p">.</span><span class="nx">recording</span><span class="p">.</span><span class="nx">filename</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nv">recordingJSON = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">recording</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">filepath</span><span class="p">,</span> <span class="nx">recordingJSON</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Outgoing request to target server.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">outgoing.host = </span><span class="nx">@target</span><span class="p">.</span><span class="nx">host</span>
    <span class="nv">outgoing.port = </span><span class="nx">@target</span><span class="p">.</span><span class="nx">port</span>
    <span class="nv">outgoing.agent = </span><span class="nx">@target</span><span class="p">.</span><span class="nx">agent</span>
    <span class="nv">outgoing.method = </span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span>
    <span class="nv">outgoing.path = </span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span>
    <span class="nv">outgoing.headers = </span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span>

    <span class="nv">reverseProxy = </span><span class="nx">@target</span><span class="p">.</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">request</span> <span class="nx">outgoing</span><span class="p">,</span> <span class="nf">(response) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Match header connection between source and target responses</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">connection</span>
        <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">connection</span>
          <span class="nv">response.headers.connection = </span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">connection</span>
        <span class="k">else</span>
          <span class="nv">response.headers.connection = </span><span class="s">&quot;close&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Remove HTTP 1.1 headers for HTTP 1.0</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">delete</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s">&quot;transfer-encoding&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">httpVersion</span> <span class="o">==</span> <span class="s">&quot;1.0&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Replace redirect scheme if we are targeting an HTTPS server</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">301</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">302</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">self</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">https</span>
          <span class="nv">response.headers.location = </span><span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^https\:/</span><span class="p">,</span> <span class="s">&quot;http:&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Start writing response to source</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span>
      <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">304</span>
        <span class="k">try</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
        <span class="k">catch</span> <span class="nx">ex</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;res.end error: %s&quot;</span><span class="p">,</span> <span class="nx">ex</span><span class="p">.</span><span class="nx">message</span>
        <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Manage stream events from target response</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">ended = </span><span class="kc">false</span>

      <span class="nv">onData = </span><span class="nf">(chunk) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Back off if throughput too high</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">res</span><span class="p">.</span><span class="nx">writable</span>
          <span class="k">if</span> <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="kc">false</span> <span class="o">and</span> <span class="nx">response</span><span class="p">.</span><span class="nx">pause</span>
            <span class="nx">response</span><span class="p">.</span><span class="nx">pause</span><span class="p">()</span>

      <span class="nv">onDrain = </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Resume when queue drained</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">readable</span> <span class="o">and</span> <span class="nx">response</span><span class="p">.</span><span class="nx">resume</span>
          <span class="nx">response</span><span class="p">.</span><span class="nx">resume</span><span class="p">()</span>

      <span class="nv">onClose = </span><span class="o">-&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">emit</span> <span class="s">&#39;end&#39;</span> <span class="nx">unless</span> <span class="nx">ended</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Close response back to client when response
from target finishes.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">onEnd = </span><span class="o">-&gt;</span>
        <span class="nv">ended = </span><span class="kc">true</span>
        <span class="nx">unless</span> <span class="nx">errState</span>
          <span class="nx">reverseProxy</span><span class="p">.</span><span class="nx">removeListener</span> <span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="nx">proxyError</span>
          <span class="k">try</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
            <span class="nx">writeRecordingToFile</span><span class="p">()</span>
          <span class="k">catch</span> <span class="nx">ex</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;res.end error: %s&quot;</span><span class="p">,</span> <span class="nx">ex</span><span class="p">.</span><span class="nx">message</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span> <span class="s">&quot;end&quot;</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span>

      <span class="nx">res</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;drain&#39;</span><span class="p">,</span> <span class="nx">onDrain</span>
      <span class="nx">response</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;data&#39;</span><span class="p">,</span> <span class="nx">onData</span>
      <span class="nx">response</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;close&#39;</span><span class="p">,</span> <span class="nx">onClose</span>
      <span class="nx">response</span><span class="p">.</span><span class="kc">on</span> <span class="s">&quot;end&quot;</span><span class="p">,</span> <span class="nx">onEnd</span>    

    <span class="nv">proxyError = </span><span class="nf">(err) -&gt;</span>
      <span class="nv">errState = </span><span class="kc">true</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s">&quot;proxyError&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">500</span><span class="p">,</span> <span class="s">&quot;Content-Type&quot;</span><span class="o">:</span> <span class="s">&quot;text/plain&quot;</span>

      <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">isnt</span> <span class="s">&quot;HEAD&quot;</span>
        <span class="k">if</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">is</span> <span class="s">&quot;production&quot;</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">write</span> <span class="s">&quot;Internal Server Error&quot;</span>
        <span class="k">else</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">write</span> <span class="s">&quot;An error has occurred: &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="k">try</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
      <span class="k">catch</span> <span class="nx">ex</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;res.end error: %s&quot;</span><span class="p">,</span> <span class="nx">ex</span><span class="p">.</span><span class="nx">message</span>
    <span class="nx">reverseProxy</span><span class="p">.</span><span class="nx">once</span> <span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="nx">proxyError</span>

    <span class="nx">req</span><span class="p">.</span><span class="kc">on</span> <span class="s">&quot;aborted&quot;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">reverseProxy</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>When receiving data from the client, calculate
the hash of the request body and write the chunk
to the request of the target.
Watch if the pipe to the target is backing up
and pause the client request until target socket
is drained.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">req</span><span class="p">.</span><span class="kc">on</span> <span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="nf">(chunk) -&gt;</span>
      <span class="nx">unless</span> <span class="nx">errState</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">bodyHash</span> <span class="o">||=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span> <span class="s">&#39;sha1&#39;</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">bodyHash</span><span class="p">.</span><span class="nx">update</span> <span class="nx">chunk</span>
        <span class="nv">flushed = </span><span class="nx">reverseProxy</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">flushed</span>
          <span class="nx">req</span><span class="p">.</span><span class="nx">pause</span><span class="p">()</span>
          <span class="nx">reverseProxy</span><span class="p">.</span><span class="nx">once</span> <span class="s">&quot;drain&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
            <span class="k">try</span>
              <span class="nx">req</span><span class="p">.</span><span class="nx">resume</span><span class="p">()</span>
            <span class="k">catch</span> <span class="nx">er</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;req.resume error: %s&quot;</span><span class="p">,</span> <span class="nx">er</span><span class="p">.</span><span class="nx">message</span>
          <span class="nx">setTimeout</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="nx">reverseProxy</span><span class="p">.</span><span class="nx">emit</span> <span class="s">&quot;drain&quot;</span><span class="p">),</span> <span class="mi">100</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Calculate filename once the request is finished.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">req</span><span class="p">.</span><span class="kc">on</span> <span class="s">&quot;end&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nv">res.recording.filename = </span><span class="nx">mock</span><span class="p">.</span><span class="nx">_generateResponseFilename</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">bodyHash</span><span class="o">?</span><span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s">&#39;hex&#39;</span><span class="p">))</span>
      <span class="nx">reverseProxy</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">errState</span>

    <span class="nx">req</span><span class="p">.</span><span class="kc">on</span> <span class="s">&quot;close&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">reverseProxy</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">errState</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Close all outstanding sockets to target if closed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">close: </span><span class="o">-&gt;</span>
    <span class="nv">proxy = </span><span class="nx">@target</span>
    <span class="k">if</span> <span class="nx">proxy</span> <span class="o">and</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">agent</span>
      <span class="k">for</span> <span class="nx">host</span> <span class="k">of</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">agent</span><span class="p">.</span><span class="nx">sockets</span>
        <span class="k">for</span> <span class="nx">socket</span> <span class="k">in</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">agent</span><span class="p">.</span><span class="nx">sockets</span><span class="p">[</span><span class="nx">host</span><span class="p">]</span>
          <span class="nx">socket</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 